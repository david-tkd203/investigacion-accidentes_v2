{# accidentes/templates/accidentes/partials/_hechos_wrapper.html #}
{# Requiere en contexto: hechos_generados (lista de strings), codigo, relatof (string opc), form_hechos_guardado (bool) #}

{# Estado 1: no hay hechos -> botón para identificar con IA #}
{% if not hechos_generados %}
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <p class="text-muted mb-3">
        Aún no has identificado hechos. Puedes generarlos a partir del relato final confirmado.
      </p>
      <form method="post"
            hx-post="{% url 'accidentes:ia_hechos' codigo %}"
            hx-target="#hechos-wrapper"
            hx-swap="innerHTML"
            hx-indicator="#relato-indicator">
        {% csrf_token %}
        <input type="hidden" name="action" value="identify_hechos">
        <button type="submit" class="btn btn-primary-custom w-100 w-sm-auto">
          <i class="fa-solid fa-wand-magic-sparkles me-2"></i> Identificar Hechos con IA
        </button>
      </form>
      {% if not form_hechos_guardado %}
        <p class="small text-warning mt-2 mb-0">
          <i class="fa-regular fa-circle-question me-1"></i>
          Debes confirmar el relato final antes de identificar hechos.
        </p>
      {% endif %}
    </div>
  </div>
{% else %}
  {# Estado 2: listado editable de hechos #}
  <div class="d-flex flex-column gap-2 mb-4">
    {% for fact in hechos_generados %}
      <div class="card border shadow-sm">
        <div class="card-body p-1">
          <span class="badge text-bg-secondary flex-shrink-0 badge-hecho">Hecho #{{ forloop.counter }}</span>
          <div class="d-flex align-items-start gap-3">
            <div class="flex-grow-1">
              <form method="post"
                    class="mb-2"
                    hx-post="{% url 'accidentes:ia_hechos' codigo %}"
                    hx-target="#hechos-wrapper"
                    hx-swap="innerHTML"
                    hx-indicator="#relato-indicator">
                {% csrf_token %}
                <input type="hidden" name="idx" value="{{ forloop.counter0 }}">
                <div class="mb-2">
                  <textarea name="fact_text"
                            class="form-control"
                            rows="2"
                            placeholder="Describe el hecho...">{{ fact }}</textarea>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                  <div class="d-flex flex-row gap-2">
                    <button type="submit" name="action" value="modify_fact"
                    class="btn btn-primary-custom btn-sm d-inline-flex align-items-center">
                    <i class="fa-regular fa-floppy-disk me-1"></i> Guardar
                    </button>
                    <button type="submit" name="action" value="delete_fact"
                    class="btn btn-outline-danger btn-sm d-inline-flex align-items-center">
                    <i class="fa-regular fa-trash-can me-1"></i> Eliminar
                    </button>
                  </div>

                  <div class="d-flex gap-1">
                    {% if not forloop.first %}
                      <button type="submit" name="action" value="move_up" class="btn btn-outline-secondary btn-sm px-2 py-1" data-bs-toggle="tooltip" data-bs-placement="left" data-bs-title="Subir hecho">
                        <i class="fa-solid fa-arrow-up"></i>
                      </button>
                    {% endif %}
                    {% if not forloop.last %}
                      <button type="submit" name="action" value="move_down" class="btn btn-outline-secondary btn-sm px-2 py-1" data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="Bajar hecho">
                        <i class="fa-solid fa-arrow-down"></i>
                      </button>
                    {% endif %}
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  {# Botones de acción (abajo) #}
  <div class="d-flex flex-column flex-sm-row justify-content-between align-items-stretch align-items-sm-center gap-3 pt-3 border-top">
    <form method="post"
          hx-post="{% url 'accidentes:ia_hechos' codigo %}"
          hx-target="#hechos-wrapper"
          hx-swap="innerHTML"
          hx-indicator="#relato-indicator">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_fact">
      <button type="submit" class="btn btn-primary-custom w-100 w-sm-auto">
        <i class="fa-regular fa-square-plus me-2"></i> Añadir Hecho
      </button>
    </form>

    <form method="post"
          hx-post="{% url 'accidentes:ia_hechos' codigo %}"
          hx-target="#hechos-wrapper"
          hx-swap="innerHTML"
          hx-indicator="#relato-indicator">
      {% csrf_token %}
      <input type="hidden" name="action" value="guardar_bd">
      <button type="submit" class="btn btn-primary-custom w-100 w-sm-auto">
        <i class="fa-regular fa-floppy-disk me-2"></i> Guardar Todos los Hechos
      </button>
    </form>
  </div>
{% endif %}
{% if request.META.HTTP_HX_REQUEST or is_htmx %}
  {% include "accidentes/notification.html" %}
{% endif %}