{# Requiere en contexto: medidas (QS o lista), codigo, edit_mode (bool), edit_index (int|None) #}

{% if medidas %}
  {# Toolbar superior: Agregar manualmente #}
  <div class="d-flex flex-wrap justify-content-end gap-2 mb-3">
    <button type="button"
            class="btn btn-success d-inline-flex align-items-center"
            data-bs-toggle="modal"
            data-bs-target="#addManualModal">
      <i class="fa-solid fa-plus me-2"></i> Agregar medida manual
    </button>
  </div>

  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 mb-4">
    {% for m in medidas %}
      <div class="col">
        <div class="card h-100">
          <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div class="d-flex flex-wrap gap-2">
                <span class="badge text-bg-secondary">{{ m.tipo }}</span>
                {% if m.prioridad == "Alta" %}
                  <span class="badge text-bg-danger">Alta</span>
                {% elif m.prioridad == "Media" %}
                  <span class="badge text-bg-warning">Media</span>
                {% else %}
                  <span class="badge text-bg-info">Baja</span>
                {% endif %}
              </div>

              <div class="d-flex gap-1">
                {% if not edit_mode or edit_index != forloop.counter0 %}
                  <form
                    hx-post="{% url 'accidentes:ia_medidas' codigo %}"
                    hx-target="#mc-wrapper"
                    hx-swap="innerHTML"
                    class="m-0"
                    hx-indicator="#relato-indicator">
                    {% csrf_token %}
                    <input type="hidden" name="delete" value="{{ forloop.counter0 }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger d-inline-flex align-items-center"
                            onclick="return confirm('¿Eliminar esta medida?');">
                      <i class="fa-regular fa-trash-can me-1"></i><span class="d-lg-inline">Eliminar</span>
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="card-body d-flex flex-column">
            {% if edit_mode and edit_index == forloop.counter0 %}
              <!-- Modo edición -->
              <form
                hx-post="{% url 'accidentes:ia_medidas' codigo %}"
                hx-target="#mc-wrapper"
                hx-swap="innerHTML"
                class="w-100"
                hx-indicator="#relato-indicator">
                {% csrf_token %}
                <input type="hidden" name="save" value="{{ forloop.counter0 }}">

                <div class="row g-2 mb-2">
                  <div class="col-12 col-sm-6">
                    <label class="form-label">Tipo</label>
                    <select name="medidas-{{ forloop.counter0 }}-tipo" class="form-select">
                      <option value="Ingenieril" {% if m.tipo == "Ingenieril" %}selected{% endif %}>Ingenieril</option>
                      <option value="Administrativa" {% if m.tipo == "Administrativa" %}selected{% endif %}>Administrativa</option>
                      <option value="EPP" {% if m.tipo == "EPP" %}selected{% endif %}>EPP</option>
                    </select>
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label">Prioridad</label>
                    <select name="medidas-{{ forloop.counter0 }}-prioridad" class="form-select">
                      <option value="Alta" {% if m.prioridad == "Alta" %}selected{% endif %}>Alta</option>
                      <option value="Media" {% if m.prioridad == "Media" %}selected{% endif %}>Media</option>
                      <option value="Baja" {% if m.prioridad == "Baja" %}selected{% endif %}>Baja</option>
                    </select>
                  </div>
                </div>

                <div class="row g-2 mb-3">
                  <div class="col-12 col-sm-6">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-control"
                           name="medidas-{{ forloop.counter0 }}-fecha"
                           value="{{ m.plazo|date:'Y-m-d' }}">
                  </div>
                  <div class="col-12 col-sm-6">
                    <label class="form-label">Responsable</label>
                    <input type="text" class="form-control"
                           name="medidas-{{ forloop.counter0 }}-responsable"
                           value="{{ m.responsable }}">
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Descripción</label>
                  <textarea class="form-control" rows="3"
                            name="medidas-{{ forloop.counter0 }}-descripcion"
                            placeholder="Describa la medida...">{{ m.descripcion }}</textarea>
                </div>

                <div class="d-flex flex-row justify-content-end gap-2 mt-auto">
                  <button type="submit"
                          class="btn btn-primary-custom btn-sm d-inline-flex align-items-center">
                    <i class="fa-regular fa-floppy-disk me-1"></i> Guardar
                  </button>
                  <a href="{% url 'accidentes:ia_medidas' codigo %}" class="btn btn-light btn-sm">
                    Cancelar
                  </a>
                </div>
              </form>
            {% else %}
              <!-- Vista lectura -->
              <div class="d-flex flex-column gap-2">
                <div class="d-flex align-items-center gap-2">
                  <i class="fa-regular fa-calendar text-muted"></i>
                  <span class="small fw-semibold">{{ m.plazo|date:"Y-m-d" }}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <i class="fa-regular fa-user text-muted"></i>
                  <span class="small fw-semibold">{{ m.responsable }}</span>
                </div>
              </div>

              <div class="mt-3">
                <h6 class="mb-1">Medida</h6>
                <p class="mb-0 text-muted">{{ m.descripcion }}</p>
              </div>

              <div class="mt-3 mt-auto text-end">
                <form
                  hx-post="{% url 'accidentes:ia_medidas' codigo %}"
                  hx-target="#mc-wrapper"
                  hx-swap="innerHTML"
                  class="m-0"
                  hx-indicator="#relato-indicator">
                  {% csrf_token %}
                  <input type="hidden" name="edit" value="{{ forloop.counter0 }}">
                  <button type="submit" class="btn btn-primary-custom d-inline-flex align-items-center edit-medida">
                    Editar medida
                  </button>
                </form>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Botonera inferior -->
  <div class="d-flex flex-column flex-sm-row gap-3 justify-content-end">
    <form
      hx-post="{% url 'accidentes:ia_medidas' codigo %}"
      hx-target="#mc-wrapper"
      hx-swap="innerHTML"
      hx-indicator="#relato-indicator">
      {% csrf_token %}
      <input type="hidden" name="regenerate" value="1">
      <button type="submit" class="btn btn-outline-danger d-inline-flex justify-content-center align-items-center w-100 w-sm-auto">
        <i class="fa-solid fa-rotate me-2"></i> Generar/Regenerar Medidas
      </button>
    </form>

    <form
      hx-post="{% url 'accidentes:ia_medidas' codigo %}"
      hx-target="#mc-wrapper"
      hx-swap="innerHTML"
      hx-indicator="#relato-indicator">
      {% csrf_token %}
      <input type="hidden" name="save_all" value="1">
      <button type="submit" class="btn btn-primary-custom d-inline-flex justify-content-center align-items-center w-100 w-sm-auto">
        <i class="fa-regular fa-floppy-disk me-2"></i> Guardar Todas
      </button>
    </form>
  </div>

{% else %}
  <!-- Empty state -->
  <div class="card border-0 shadow-sm">
    <div class="card-body d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <p class="text-muted mb-0">Aún no hay medidas generadas.</p>

      <div class="d-flex gap-2">
        <form
          hx-post="{% url 'accidentes:ia_medidas' codigo %}"
          hx-target="#mc-wrapper"
          hx-swap="innerHTML"
          hx-indicator="#relato-indicator">
          {% csrf_token %}
          <input type="hidden" name="regenerate" value="1">
          <button type="submit" class="btn btn-primary-custom d-inline-flex align-items-center">
            <i class="fa-solid fa-wand-magic-sparkles me-2"></i> Generar medidas correctivas
          </button>
        </form>

      </div>
    </div>
  </div>
{% endif %}

<!-- Modal: Agregar medida manual -->
<div class="modal fade" id="addManualModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form
      hx-post="{% url 'accidentes:ia_medidas' codigo %}"
      hx-target="#mc-wrapper"
      hx-swap="innerHTML"
      hx-indicator="#relato-indicator"


      hx-on="htmx:beforeRequest:
        (function(){
          var el = document.getElementById('addManualModal');
          if(!el) return;
          try{ bootstrap.Modal.getOrCreateInstance(el).hide(); }catch(_){}
        })()"
    >
      {% csrf_token %}
      <input type="hidden" name="add_manual" value="1">

        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Tipo</label>
              <select name="tipo" class="form-select">
                <option>Administrativa</option>
                <option>Ingenieril</option>
                <option>EPP</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Prioridad</label>
              <select name="prioridad" class="form-select">
                <option>Alta</option>
                <option selected>Media</option>
                <option>Baja</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Fecha</label>
              <input type="date" name="fecha" class="form-control">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Responsable</label>
              <input type="text" name="responsable" class="form-control">
            </div>
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <textarea name="descripcion" class="form-control" rows="3"></textarea>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <!-- IMPORTANTE: cierra el modal al hacer submit -->
          <button type="submit" class="btn btn-primary-custom" data-bs-dismiss="modal">Agregar</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% if request.META.HTTP_HX_REQUEST or is_htmx %}
  {% include "accidentes/notification.html" %}
{% endif %}
